"""
Scope 10.150.202.0 add excluderange 10.150.202.150 10.150.202.250
Scope 10.150.202.0 add excluderange 10.150.202.50 10.150.202.149
Scope 10.150.204.0 add excluderange 10.150.204.159 10.150.204.159
Scope 10.150.204.0 add excluderange 10.150.204.170 10.150.204.170
Scope 10.150.204.0 add excluderange 10.150.204.173 10.150.207.250
Scope 10.150.204.0 add excluderange 10.150.204.96 10.150.207.172
Scope 10.150.204.0 add excluderange 10.150.207.240 10.150.207.249
Scope 10.150.208.0 add excluderange 10.150.208.16 10.150.209.255
Scope 10.150.208.0 add excluderange 10.150.210.0 10.150.211.254
Scope 10.150.217.0 add excluderange 10.150.217.135 10.150.217.254
Scope 10.150.217.0 add excluderange 10.150.217.16 10.150.217.134
Scope 10.150.224.0 add excluderange 10.150.224.16 10.150.231.254
Scope 10.150.224.0 add excluderange 10.150.232.0 10.150.239.254
Scope 10.150.240.0 add excluderange 10.150.240.1 10.150.240.132
Scope 10.150.240.0 add excluderange 10.150.240.1 10.150.240.15
Scope 10.192.10.0 add excluderange 10.192.10.162 10.192.10.254
Scope 10.192.10.0 add excluderange 10.192.10.219 10.192.10.219
Scope 10.192.10.0 add excluderange 10.192.10.71 10.192.10.161
Scope 10.192.12.0 add excluderange 10.192.12.100 10.192.12.107
Scope 10.192.12.0 add excluderange 10.192.12.1 10.192.13.255
Scope 10.192.12.0 add excluderange 10.192.14.0 10.192.15.202
Scope 10.192.50.0 add excluderange 10.192.50.150 10.192.50.250
Scope 10.192.50.0 add excluderange 10.192.50.50 10.192.50.149
Scope 10.192.51.0 add excluderange 10.192.51.150 10.192.51.250
Scope 10.192.51.0 add excluderange 10.192.51.50 10.192.51.149
Scope 10.192.52.0 add excluderange 10.192.52.150 10.192.52.250
Scope 10.192.52.0 add excluderange 10.192.52.240 10.192.52.250
Scope 10.192.52.0 add excluderange 10.192.52.50 10.192.52.149
Scope 10.192.53.0 add excluderange 10.192.53.150 10.192.53.250
Scope 10.192.53.0 add excluderange 10.192.53.50 10.192.53.149
Scope 10.192.54.0 add excluderange 10.192.54.150 10.192.54.250
Scope 10.192.54.0 add excluderange 10.192.54.50 10.192.54.149
Scope 10.192.60.0 add excluderange 10.192.60.150 10.192.60.250
Scope 10.192.60.0 add excluderange 10.192.60.50 10.192.60.149
Scope 10.194.10.0 add excluderange 10.194.10.100 10.194.10.160
Scope 10.194.10.0 add excluderange 10.194.10.100 10.194.10.174
Scope 10.194.10.0 add excluderange 10.194.10.161 10.194.10.161
Scope 10.194.10.0 add excluderange 10.194.10.175 10.194.10.254
Scope 10.194.50.0 add excluderange 10.194.50.150 10.194.50.250
Scope 10.194.50.0 add excluderange 10.194.50.50 10.194.50.149
Scope 10.194.51.0 add excluderange 10.194.51.150 10.194.51.250
Scope 10.194.51.0 add excluderange 10.194.51.50 10.194.51.149
Scope 10.194.52.0 add excluderange 10.194.52.150 10.194.52.250
Scope 10.194.52.0 add excluderange 10.194.52.50 10.194.52.149
Scope 10.194.53.0 add excluderange 10.194.53.100 10.194.53.174
Scope 10.194.53.0 add excluderange 10.194.53.175 10.194.53.250
Scope 10.194.54.0 add excluderange 10.194.54.150 10.194.54.250
Scope 10.194.54.0 add excluderange 10.194.54.50 10.194.54.149
Scope 10.194.60.0 add excluderange 10.194.60.150 10.194.60.250
Scope 10.194.60.0 add excluderange 10.194.60.50 10.194.60.149
Scope 10.195.10.0 add excluderange 10.195.10.100 10.195.10.119
Scope 10.195.10.0 add excluderange 10.195.10.120 10.195.10.149
Scope 10.195.10.0 add excluderange 10.195.10.50 10.195.10.50
Scope 10.195.10.0 add excluderange 10.195.10.77 10.195.10.99
Scope 10.195.50.0 add excluderange 10.195.50.150 10.195.50.250
Scope 10.195.50.0 add excluderange 10.195.50.50 10.195.50.149
Scope 10.195.51.0 add excluderange 10.195.51.150 10.195.51.250
Scope 10.195.51.0 add excluderange 10.195.51.50 10.195.51.149
Scope 10.195.52.0 add excluderange 10.195.52.150 10.195.52.250
Scope 10.195.52.0 add excluderange 10.195.52.50 10.195.52.149
Scope 10.195.53.0 add excluderange 10.195.53.100 10.195.53.174
Scope 10.195.53.0 add excluderange 10.195.53.175 10.195.53.250
Scope 10.195.54.0 add excluderange 10.195.54.150 10.195.54.250
Scope 10.195.54.0 add excluderange 10.195.54.50 10.195.54.149
Scope 10.195.55.0 add excluderange 10.195.55.200 10.195.55.254
Scope 10.195.60.0 add excluderange 10.195.60.150 10.195.60.250
Scope 10.195.60.0 add excluderange 10.195.60.50 10.195.60.149
Scope 10.201.175.0 add excluderange 10.201.175.150 10.201.175.250
Scope 10.201.175.0 add excluderange 10.201.175.50 10.201.175.149
Scope 10.201.200.0 add excluderange 10.201.200.100 10.201.200.150
Scope 10.201.200.0 add excluderange 10.201.200.151 10.201.200.200
Scope 10.202.224.0 add excluderange 10.202.224.100 10.202.224.150
Scope 10.202.224.0 add excluderange 10.202.224.151 10.202.224.200
Scope 10.250.250.0 add excluderange 10.250.250.100 10.250.250.150
Scope 10.250.250.0 add excluderange 10.250.250.151 10.250.250.200
Scope 10.252.0.0 add excluderange 10.252.18.1 10.252.18.250
Scope 10.254.0.0 add excluderange 10.254.0.16 10.254.6.255
Scope 10.254.0.0 add excluderange 10.254.7.0 10.254.15.254
Scope 10.40.0.0 add excluderange 10.40.101.1 10.40.102.255
Scope 10.40.0.0 add excluderange 10.40.103.0 10.40.104.254
Scope 10.41.0.0 add excluderange 10.41.101.1 10.41.102.255
Scope 10.41.0.0 add excluderange 10.41.103.0 10.41.104.254
Scope 10.42.0.0 add excluderange 10.42.101.1 10.42.102.255
Scope 10.42.0.0 add excluderange 10.42.103.0 10.42.104.254
Scope 10.43.0.0 add excluderange 10.43.101.1 10.43.102.255
Scope 10.43.0.0 add excluderange 10.43.103.1 10.43.104.254
Scope 10.50.0.0 add excluderange 10.50.50.1 10.50.51.255
Scope 10.50.0.0 add excluderange 10.50.52.0 10.50.53.254
Scope 10.51.0.0 add excluderange 10.51.50.1 10.51.51.255
Scope 10.51.0.0 add excluderange 10.51.52.0 10.51.53.254
Scope 10.52.0.0 add excluderange 10.52.50.1 10.52.51.255
Scope 10.53.0.0 add excluderange 10.53.50.1 10.53.51.255
Scope 10.53.0.0 add excluderange 10.53.52.0 10.53.53.254
Scope 10.61.202.0 add excluderange 10.61.202.1 10.61.202.1
Scope 10.61.202.0 add excluderange 10.61.202.1 10.61.202.127
Scope 10.61.202.0 add excluderange 10.61.202.128 10.61.202.254
Scope 10.61.203.0 add excluderange 10.61.203.1 10.61.203.1
Scope 10.61.203.0 add excluderange 10.61.203.128 10.61.203.254
Scope 10.61.204.0 add excluderange 10.61.204.1 10.61.204.1
Scope 10.61.204.0 add excluderange 10.61.204.1 10.61.204.127
Scope 10.61.204.0 add excluderange 10.61.204.128 10.61.204.254
Scope 10.61.205.0 add excluderange 10.61.205.1 10.61.205.1
Scope 10.61.205.0 add excluderange 10.61.205.1 10.61.205.127
Scope 10.61.205.0 add excluderange 10.61.205.128 10.61.205.254
Scope 10.64.0.0 add excluderange 10.64.50.1 10.64.51.255
Scope 10.64.0.0 add excluderange 10.64.52.0 10.64.53.254
"""

from ipaddress import ip_address

print('Paste in the output from this command then hit Enter twice:')
print(r'fgrep excluderange netsh-utf* | cut -d\: -f2 | cut -d\  -f4- | sort -u')  # noqa
print('')

# Get user input
lines = []
user_input = 'x'
while user_input != '':
    user_input = input()
    lines.append(user_input)

exclusions = {}
shared = {}
ranges = {}

# Process user input
for line in lines:
    if not line:
        continue

    # Get rid of columns we don't care about
    line = line.replace('Scope ', '').replace('add excluderange ', '')

    scope_str, ex_start_str, ex_end_str = line.split(' ')
    scope = ip_address(scope_str)
    scope_ex = []
    ex_start = ip_address(ex_start_str)
    ex_end = ip_address(ex_end_str)
    
    # Each scope is a key "exclusions", value is a list of ranges
    # This populates each range as a list of IPAddress objects
    # These can be used numerically for sorting & comparing
    for ip_int in range(int(ex_start), int(ex_end) + 1):
        scope_ex.append(ip_address(ip_int))

    if scope not in exclusions:
        exclusions[scope] = []
        shared[scope] = set()
        ranges[scope] = []
    # Add this range to the list of ranges for the scope
    exclusions[scope].append(scope_ex)

# Scopes with only 1 range always need to be processed
for scope, range_list in exclusions.items():
    if len(range_list) == 1:
        for ip_addr in range_list[0]:
            shared[scope].add(ip_addr)

# Find shared exclusions for each scope's exclusion ranges
for scope, range_list in exclusions.items():
    while range_list:
        current = range_list.pop()
        for ip_addr in current:
            for remaining in range_list:
                if ip_addr in remaining:
                    shared[scope].add(ip_addr)

# Turn lists of IPs into dash-separated ranges
for scope, shared_set in shared.items():
    shared_list = list(sorted(shared_set))
    if not shared_list:
        continue
    range_list = []
    range_start = shared_list[0]
    range_end = shared_list[0]
    last_ip = None
    final_ip = shared_list[-1]
    for ip_addr in shared_list:

        if last_ip:
            if int(ip_addr) == int(last_ip) + 1:
                # Extend the range
                range_end = ip_addr
                last_ip = ip_addr
                if ip_addr == final_ip:
                    # Last IP for scope, add range to list
                    ranges[scope].append((range_start, range_end))
            else:
                # IP does not follow previous IP
                # Add previous range to list
                ranges[scope].append((range_start, range_end))
                # Begin new range
                range_start = ip_addr
                range_end = ip_addr
                last_ip = ip_addr
                if ip_addr == final_ip:
                    # Last IP for scope, add range to list
                    ranges[scope].append((range_start, range_end))
        else:
            # First iteration
            if ip_addr == final_ip:
                # Last IP for scope, add range to list
                ranges[scope].append((range_start, range_end))
            else:
                last_ip = ip_addr      

# print('Number of Shared Excluded IPs')
# for key, val in shared.items():
#    print(f'{key}\t{len(val)}')
# print('')

print('Shared Excluded Ranges')
for scope in sorted(ranges.keys()):
    range_list = ranges[scope]
    scope_ranges = []
    for ip_range in range_list:
        scope_ranges.append(f'{ip_range[0]}-{ip_range[1]}')
    print(f'"{scope}","{",".join(scope_ranges)}"')
